<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversor de Imágenes a WEBP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding-top: 2rem;
      background-color: #f8f9fa;
    }
    .drop-zone {
      border: 2px dashed #0d6efd;
      border-radius: 5px;
      padding: 3rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background-color: rgba(13, 110, 253, 0.05);
    }
    .drop-zone:hover {
      background-color: rgba(13, 110, 253, 0.1);
    }
    .drop-zone.active {
      border-color: #198754;
      background-color: rgba(25, 135, 84, 0.1);
    }
    .preview-image {
      max-width: 100%;
      max-height: 300px;
      margin: 1rem 0;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .image-card {
      margin-bottom: 1rem;
      transition: transform 0.3s;
    }
    .image-card:hover {
      transform: translateY(-5px);
    }
    #imagePreviewContainer, #resultContainer {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Conversor WEBP</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link active" href="/">Conversión Individual</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/multiple">Conversión Múltiple</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <h1 class="text-center mb-4">Conversor de Imágenes a WEBP</h1>
    <h3 class="text-center mb-4">Modo Individual</h3>
    
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div id="uploadContainer">
              <div class="drop-zone" id="dropZone">
                <span class="drop-zone-prompt">Arrastra una imagen aquí o haz clic para seleccionar</span>
                <input type="file" id="fileInput" class="d-none" accept="image/*">
              </div>
            </div>
            
            <div id="imagePreviewContainer" class="text-center mt-3">
              <img id="imagePreview" class="preview-image">
              <div class="mt-3">
                <label for="qualityRange" class="form-label">Calidad (1-100): <span id="qualityValue">75</span></label>
                <input type="range" class="form-range" min="1" max="100" value="75" id="qualityRange">
              </div>
              <div class="mt-3">
                <button id="convertBtn" class="btn btn-primary me-2">Convertir a WEBP</button>
                <button id="cancelBtn" class="btn btn-secondary">Cancelar</button>
              </div>
            </div>
            
            <div id="resultContainer" class="mt-4">
              <div class="alert alert-success">
                <h5 class="alert-heading">¡Conversión completada!</h5>
                <p id="resultMessage"></p>
              </div>
              <div class="text-center">
                <img id="convertedImage" class="preview-image">
                <div class="mt-3">
                  <a id="downloadBtn" class="btn btn-success me-2" download>Descargar</a>
                  <button id="newConversionBtn" class="btn btn-primary">Nueva conversión</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elementos DOM
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const imagePreview = document.getElementById('imagePreview');
      const imagePreviewContainer = document.getElementById('imagePreviewContainer');
      const uploadContainer = document.getElementById('uploadContainer');
      const resultContainer = document.getElementById('resultContainer');
      const convertBtn = document.getElementById('convertBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const qualityRange = document.getElementById('qualityRange');
      const qualityValue = document.getElementById('qualityValue');
      const resultMessage = document.getElementById('resultMessage');
      const convertedImage = document.getElementById('convertedImage');
      const downloadBtn = document.getElementById('downloadBtn');
      const newConversionBtn = document.getElementById('newConversionBtn');
      
      // Configuración del rango de calidad
      qualityRange.addEventListener('input', function() {
        qualityValue.textContent = this.value;
      });
      
      // Configuración de la zona de drop
      dropZone.addEventListener('click', () => fileInput.click());
      
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('active');
      });
      
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('active');
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          handleFileSelection();
        }
      });
      
      fileInput.addEventListener('change', handleFileSelection);
      
      function handleFileSelection() {
        if (fileInput.files.length === 0) return;
        
        const file = fileInput.files[0];
        if (!file.type.startsWith('image/')) {
          alert('Por favor, selecciona un archivo de imagen válido.');
          return;
        }
        
        // Mostrar previsualización
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.src = e.target.result;
          imagePreviewContainer.style.display = 'block';
          uploadContainer.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
      
      // Cancelar selección
      cancelBtn.addEventListener('click', resetUploadForm);
      
      function resetUploadForm() {
        fileInput.value = '';
        imagePreviewContainer.style.display = 'none';
        uploadContainer.style.display = 'block';
        resultContainer.style.display = 'none';
      }
      
      // Nueva conversión
      newConversionBtn.addEventListener('click', function() {
        resetUploadForm();
      });
      
      // Convertir imagen
      convertBtn.addEventListener('click', function() {
        if (fileInput.files.length === 0) return;
        
        const file = fileInput.files[0];
        const quality = qualityRange.value;
        
        const formData = new FormData();
        formData.append('image', file);
        formData.append('quality', quality);
        
        convertBtn.disabled = true;
        convertBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Convirtiendo...';
        
        // Usar la función serverless en lugar de la API
        fetch('/.netlify/functions/convert', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => {
              throw new Error(err.error || 'Error en el servidor');
            });
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            // Mostrar resultado
            document.querySelector('#resultContainer .alert').className = 'alert alert-success';
            document.querySelector('#resultContainer .alert-heading').textContent = '¡Conversión completada!';
            resultMessage.textContent = `Imagen convertida con calidad ${data.quality}.`;
            
            // Si la imagen viene como dataUrl (formato Base64)
            if (data.dataUrl) {
              // Mostrar la imagen
              convertedImage.src = data.dataUrl;
              
              // Configurar el botón de descarga
              downloadBtn.href = data.dataUrl;
              downloadBtn.download = data.convertedImage;
              
              // Descargar automáticamente
              const downloadLink = document.createElement('a');
              downloadLink.href = data.dataUrl;
              downloadLink.download = data.convertedImage;
              document.body.appendChild(downloadLink);
              downloadLink.click();
              document.body.removeChild(downloadLink);
            } else if (data.convertedImageUrl) {
              // Retro-compatibilidad con el código anterior
              convertedImage.src = data.convertedImageUrl;
              downloadBtn.href = data.convertedImageUrl;
            }
            
            imagePreviewContainer.style.display = 'none';
            resultContainer.style.display = 'block';
          } else {
            document.querySelector('#resultContainer .alert').className = 'alert alert-danger';
            document.querySelector('#resultContainer .alert-heading').textContent = '¡Error!';
            resultMessage.textContent = `Error: ${data.error}`;
            resultContainer.style.display = 'block';
            imagePreviewContainer.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error al convertir la imagen:', error);
          document.querySelector('#resultContainer .alert').className = 'alert alert-danger';
          document.querySelector('#resultContainer .alert-heading').textContent = '¡Error!';
          resultMessage.textContent = error.message || 'Error al convertir la imagen. Por favor, intenta de nuevo.';
          resultContainer.style.display = 'block';
          imagePreviewContainer.style.display = 'none';
        })
        .finally(() => {
          convertBtn.disabled = false;
          convertBtn.textContent = 'Convertir a WEBP';
        });
      });
    });
  </script>
</body>
</html> 